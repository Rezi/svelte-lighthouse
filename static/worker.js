const t=Symbol("Comlink.proxy"),n=Symbol("Comlink.endpoint"),e=Symbol("Comlink.releaseProxy"),a=new WeakSet,o=new Map([["proxy",{canHandle:n=>n&&n[t],serialize(t){const{port1:n,port2:e}=new MessageChannel;return r(t,n),[e,[e]]},deserialize:t=>(t.start(),function(t,a){return function t(a,o=[],r=function(){}){let c=!1;const m=new Proxy(r,{get(n,r){if(s(c),r===e)return()=>h(a,{type:5,path:o.map(t=>t.toString())}).then(()=>{i(a),c=!0});if("then"===r){if(0===o.length)return{then:()=>m};const t=h(a,{type:0,path:o.map(t=>t.toString())}).then(l);return t.then.bind(t)}return t(a,[...o,r])},set(t,n,e){s(c);const[r,i]=d(e);return h(a,{type:1,path:[...o,n].map(t=>t.toString()),value:r},i).then(l)},apply(e,r,i){s(c);const d=o[o.length-1];if(d===n)return h(a,{type:4}).then(l);if("bind"===d)return t(a,o.slice(0,-1));const[m,f]=u(i);return h(a,{type:2,path:o.map(t=>t.toString()),argumentList:m},f).then(l)},construct(t,n){s(c);const[e,r]=u(n);return h(a,{type:3,path:o.map(t=>t.toString()),argumentList:e},r).then(l)}});return m}(t,[],a)}(t))}],["throw",{canHandle:t=>a.has(t),serialize(t){const n=t instanceof Error;let e=t;return n&&(e={isError:n,message:t.message,stack:t.stack}),[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error,t);throw t}}]]);function r(n,e=self){e.addEventListener("message",function o(s){if(!s||!s.data)return;const{id:u,type:h,path:m}=Object.assign({path:[]},s.data),f=(s.data.argumentList||[]).map(l);let g;try{const e=m.slice(0,-1).reduce((t,n)=>t[n],n),o=m.reduce((t,n)=>t[n],n);switch(h){case 0:g=o;break;case 1:e[m.slice(-1)[0]]=l(s.data.value),g=!0;break;case 2:g=o.apply(e,f);break;case 3:g=function(n){return Object.assign(n,{[t]:!0})}(new o(...f));break;case 4:{const{port1:t,port2:e}=new MessageChannel;r(n,e),g=function(t,n){return c.set(t,n),t}(t,[t])}break;case 5:g=void 0}}catch(t){g=t,a.add(t)}Promise.resolve(g).catch(t=>(a.add(t),t)).then(t=>{const[n,a]=d(t);e.postMessage(Object.assign(Object.assign({},n),{id:u}),a),5===h&&(e.removeEventListener("message",o),i(e))})}),e.start&&e.start()}function i(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function s(t){if(t)throw new Error("Proxy has been released and is not useable")}function u(t){const n=t.map(d);return[n.map(t=>t[0]),(e=n.map(t=>t[1]),Array.prototype.concat.apply([],e))];var e}const c=new WeakMap;function d(t){for(const[n,e]of o)if(e.canHandle(t)){const[a,o]=e.serialize(t);return[{type:3,name:n,value:a},o]}return[{type:0,value:t},c.get(t)||[]]}function l(t){switch(t.type){case 3:return o.get(t.name).deserialize(t.value);case 0:return t.value}}function h(t,n,e){return new Promise(a=>{const o=new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");t.addEventListener("message",function n(e){e.data&&e.data.id&&e.data.id===o&&(t.removeEventListener("message",n),a(e.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:o},n),e)})}const m={};var f=Math.PI,g=Math.sin,p=Math.cos,M=Math.tan,v=Math.asin,y=Math.atan2,P=Math.acos,w=f/180,b=864e5,E=2440588,k=2451545;function S(t){return function(t){return t.valueOf()/b-.5+E}(t)-k}var L=23.4397*w;function z(t,n){return y(g(t)*p(L)-M(n)*g(L),p(t))}function D(t,n){return v(g(n)*p(L)+p(n)*g(L)*g(t))}function I(t,n,e){return y(g(t),p(t)*g(n)-M(e)*p(n))}function O(t,n,e){return v(g(n)*g(e)+p(n)*p(e)*p(t))}function j(t,n){return w*(280.16+360.9856235*t)-n}function A(t){var n=function(t){return t+w*(1.9148*g(t)+.02*g(2*t)+3e-4*g(3*t))+102.9372*w+f}(function(t){return w*(357.5291+.98560028*t)}(t));return{dec:D(n,0),ra:z(n,0)}}m.getPosition=function(t,n,e){var a=w*-e,o=w*n,r=S(t),i=A(r),s=j(r,a)-i.ra;return{azimuth:I(s,o,i.dec),altitude:O(s,o,i.dec)}};var H=m.times=[[-.833,"sunrise","sunset"],[-.3,"sunriseEnd","sunsetStart"],[-6,"dawn","dusk"],[-12,"nauticalDawn","nauticalDusk"],[-18,"nightEnd","night"],[6,"goldenHourEnd","goldenHour"]];function C(t){var n=w*(134.963+13.064993*t),e=w*(93.272+13.22935*t),a=w*(218.316+13.176396*t)+6.289*w*g(n),o=5.128*w*g(e),r=385001-20905*p(n);return{ra:z(a,o),dec:D(a,o),dist:r}}function x(t,n){return new Date(t.valueOf()+n*b/24)}m.addTime=function(t,n,e){H.push([t,n,e])},m.getMoonPosition=function(t,n,e){var a=w*-e,o=w*n,r=S(t),i=C(r),s=j(r,a)-i.ra,u=O(s,o,i.dec),c=y(g(s),M(o)*p(i.dec)-g(i.dec)*p(s));return u+=function(t){return t<0&&(t=0),2967e-7/Math.tan(t+.00312536/(t+.08901179))}(u),{azimuth:I(s,o,i.dec),altitude:u,distance:i.dist,parallacticAngle:c}},m.getMoonIllumination=function(t){var n=S(t||new Date),e=A(n),a=C(n),o=P(g(e.dec)*g(a.dec)+p(e.dec)*p(a.dec)*p(e.ra-a.ra)),r=y(149598e3*g(o),a.dist-149598e3*p(o)),i=y(p(e.dec)*g(e.ra-a.ra),g(e.dec)*p(a.dec)-p(e.dec)*g(a.dec)*p(e.ra-a.ra));return{fraction:(1+p(r))/2,phase:.5+.5*r*(i<0?-1:1)/Math.PI,angle:i}},m.getMoonTimes=function(t,n,e,a){var o=new Date(t);a?o.setUTCHours(0,0,0,0):o.setHours(0,0,0,0);for(var r,i,s,u,c,d,l,h,f,g,p,M,v,y=.133*w,P=m.getMoonPosition(o,n,e).altitude-y,b=1;b<=24&&(r=m.getMoonPosition(x(o,b),n,e).altitude-y,h=((c=(P+(i=m.getMoonPosition(x(o,b+1),n,e).altitude-y))/2-r)*(l=-(d=(i-P)/2)/(2*c))+d)*l+r,g=0,(f=d*d-4*c*r)>=0&&(p=l-(v=Math.sqrt(f)/(2*Math.abs(c))),M=l+v,Math.abs(p)<=1&&g++,Math.abs(M)<=1&&g++,p<-1&&(p=M)),1===g?P<0?s=b+p:u=b+p:2===g&&(s=b+(h<0?M:p),u=b+(h<0?p:M)),!s||!u);b+=2)P=i;var E={};return s&&(E.rise=x(o,s)),u&&(E.set=x(o,u)),s||u||(E[h>0?"alwaysUp":"alwaysDown"]=!0),E},r({animateSun(t,n,e){const a=m.getPosition(t,e.lat,e.lon),o=100*a.altitude/(Math.PI/2);return{sunDegAngle:o,animationKey:n,sunBottomPosition:o+14+"vh",sunLeftPosition:a.azimuth/Math.PI*50+50}},animateMoon(t,n,e,a,o){let r=m.getMoonIllumination(t).phase;n&&(a=r<.5?7.8-31.2*r:-7.8,o=r>=.5?7.8-31.2*(r-.5):7.8),e.prevMoonPhase=r;const i=e.dataSet.city.coord,s=m.getMoonPosition(t,i.lat,i.lon);return moonBottomPosition=100*s.altitude/(Math.PI/2)+14+"vh",moonLeftPosition=s.azimuth/Math.PI*50+50,moonRotationDeg=180*s.parallacticAngle/Math.PI,{moonBottomPosition:moonBottomPosition,moonLeftPosition:moonLeftPosition,moonRotationDeg:moonRotationDeg,moonLeft:a,moonRight:o}}});

<script>
  import { generateCloud } from "../helpers/cloud-generator";
  import { isBrowser } from "../helpers/helpers";
  import { onMount } from "svelte";

  let value;
  let canvas;
  let cloudURI;
  let windowWidth;
  let windowHeight;

  $: fetchCities(value);

  let cities = [];

  async function fetchCities(value) {
    if (value && value.length > 2) {
      const response = await fetch(
        `https://openweathermap.org/data/2.5/find?q=${value}&type=like&sort=population&cnt=30&appid=b6907d289e10d714a6e88b30761fae22&_=1583447022166`
      );
      const data = await response.json();
      if (data.list) {
        cities = data.list;
      } else {
        cities = [];
      }
    }
  }

  onMount(() => {
    cities = JSON.parse(localStorage.getItem("cities")) || [];
    const cloudBallSize = Math.min(windowWidth, windowHeight) / 3;

    cloudURI = generateCloud(
      1,
      canvas,
      windowWidth * 1.5,
      windowHeight * 1.5,
      cloudBallSize,
      90
    );
  });

  function addCity(city, event) {
    if (isBrowser()) {
      let oldCities = JSON.parse(localStorage.getItem("cities"));
      const newCity = {
        name: city.name,
        id: city.id,
        sys: { country: city.sys.country }
      };

      if (
        oldCities &&
        !oldCities.find(oldCity => {
          return oldCity.id === city.id;
        })
      ) {
        oldCities.push(newCity);
      } else if (!oldCities || !oldCities.length) {
        oldCities = [newCity];
      }

      localStorage.setItem("cities", JSON.stringify(oldCities));
    }
  }

  function deleteCity(city, event) {
    event.preventDefault();
    event.stopPropagation();
    if (isBrowser()) {
      const oldCities = JSON.parse(localStorage.getItem("cities"));
      cities = oldCities.filter(oldCity => {
        return oldCity.id !== city.id;
      });

      localStorage.setItem("cities", JSON.stringify(cities));
    }
  }
</script>

<style type="text/scss">
  @import "../variables.scss";

  :global(html) {
    background-color: $color-bg-sky-bottom;
  }

  .search {
    width: 100%;
    min-height: 100vh;
    background: linear-gradient(
      0deg,
      $color-bg-sky-bottom 0%,
      $color-bg-sky-top 100%
    );
    position: relative;
  }

  .cloud-wrap {
    width: 100%;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }

  .app-name {
    position: absolute;
    top: 10vh;
    font-size: 5vh;
    color: $color-app-name;
    padding: 0 5vw;
    text-align: center;

    svg {
      fill: currentColor;
      width: 80vw;
      max-width: 30rem;
    }
  }

  .cloud-image {
    position: relative;
    top: 12vh;
    transform: translateY(-50%);
  }

  .search-wrap {
    position: absolute;
    top: 35vh;
    width: 100%;
    display: flex;
    justify-content: center;
  }

  .search-box {
    max-width: 30rem;
    padding: 0 5vw;
    width: 100%;
    box-sizing: border-box;
  }

  .search-label {
    font-size: 1.5rem;
    display: flex;
    flex-direction: column;
  }

  .search-input {
    height: 2.5rem;
    border-radius: 0.5rem;
    border: 0;
    padding: 0.3rem 0.8rem;
    font-size: 1.5rem;
    margin-top: 1rem;
  }

  .search-results {
    margin-top: 2rem;
    padding: 0;
  }

  .search-results--item {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: $color-search;
    display: flex;
    justify-content: space-between;
    text-decoration: none;
  }

  .temperature {
    color: $color-temperature;
  }

  .delete {
    fill: currentColor;
    width: 1.5rem;
  }

  .canvas {
    display: none;
  }
</style>

<svelte:window bind:innerWidth={windowWidth} bind:innerHeight={windowHeight} />

<svelte:head>
  <title>I see Weather</title>
  <meta
    name="description"
    content="A weather forecast app, in which you just see the weather" />
  <link rel="preconnect" href="//api.openweathermap.org" />
  <link rel="dns-prefetch" href="//api.openweathermap.org" />

</svelte:head>

<section class="search">
  <div class="cloud-wrap">
    <img src={cloudURI} alt="cloud" class="cloud-image" />
    <div class="app-name">

      <!-- Generated by IcoMoon.io -->
      <svg viewBox="0 14 32 32">
        <title>the weather app</title>
        <path
          d="M27.464 18.827c-0.026-0.067 0.059-0.584 0.189-1.15s0.257-1.238
          0.284-1.493c0.027-0.255 0.071-0.464 0.099-0.464 0.098 0 0.233 0.185
          0.233 0.32 0 0.188 0.052 0.174 0.355-0.091 0.36-0.316 0.592-0.301
          0.778 0.052 0.338 0.643-0.276 1.577-1.19 1.81-0.349 0.089-0.352
          0.092-0.454 0.542-0.113 0.496-0.218 0.667-0.292 0.474zM28.481
          17.405c0.546-0.28 0.851-0.8
          0.7-1.195-0.087-0.229-0.138-0.23-0.461-0.012-0.455 0.307-0.954
          1.352-0.646 1.352 0.068 0 0.251-0.065 0.406-0.145zM29.54
          18.815c-0.023-0.059 0.057-0.526 0.178-1.038s0.241-1.123
          0.268-1.36c0.087-0.764 0.19-0.894 0.37-0.467 0.095 0.226 0.1 0.228
          0.231 0.083 0.173-0.192 0.545-0.344 0.697-0.286 0.181 0.069 0.361
          0.568 0.307 0.852-0.095 0.504-0.964 1.248-1.464 1.253-0.139
          0.001-0.183 0.083-0.294 0.535-0.128 0.523-0.209 0.641-0.292
          0.426zM30.456 17.469c0.608-0.23 1.082-1.091
          0.752-1.365-0.248-0.206-0.825 0.365-1.068 1.055-0.065 0.184-0.118
          0.347-0.118 0.362 0 0.055 0.22 0.028 0.434-0.053zM2.428
          17.722c-0.047-0.090-0.010-0.381 0.116-0.896 0.155-0.636 0.404-2.037
          0.406-2.278 0-0.037 0.056-0.020 0.125 0.036 0.165 0.137 0.1
          0.915-0.155 1.86-0.102 0.378-0.177 0.695-0.166 0.705s0.198-0.256
          0.417-0.592c0.219-0.336 0.486-0.669 0.595-0.74 0.191-0.125 0.202-0.123
          0.377 0.081 0.111 0.129 0.181 0.307 0.181 0.46 0 0.346-0.286
          1.197-0.464 1.379-0.146 0.15-0.147 0.15-0.147-0.007 0-0.087
          0.069-0.357 0.153-0.601 0.165-0.481 0.196-0.841
          0.078-0.914-0.156-0.096-0.39 0.138-0.875 0.876-0.276 0.419-0.517
          0.762-0.536 0.762s-0.066-0.060-0.104-0.133zM4.948
          17.666c-0.203-0.171-0.244-0.258-0.242-0.523 0.003-0.564 0.442-1.245
          0.891-1.38 0.382-0.115 0.871 0.407 0.747 0.797-0.073 0.231-0.517
          0.397-0.984 0.367-0.376-0.024-0.389-0.018-0.413 0.189-0.039 0.344
          0.111 0.456 0.555 0.414 0.211-0.020 0.444-0.062 0.518-0.093
          0.203-0.086 0.162 0.090-0.054 0.232-0.103 0.068-0.319 0.141-0.48
          0.162-0.24 0.032-0.336 0.002-0.537-0.166zM6.056 16.536c0.11-0.11
          0.109-0.138-0.007-0.316-0.070-0.107-0.199-0.195-0.286-0.195-0.197
          0-0.708 0.497-0.635 0.617 0.076 0.123 0.779 0.043 0.928-0.106zM8.761
          17.764c-0.11-0.11-0.117-0.612-0.020-1.371 0.039-0.307 0.093-0.789
          0.12-1.070 0.046-0.481 0.057-0.506 0.195-0.42 0.184 0.115 0.183
          0.211-0.010 1.396-0.134 0.823-0.149 1.151-0.048 1.016 0.013-0.017
          0.147-0.203 0.298-0.413 0.365-0.507 0.653-0.772 0.742-0.682 0.039
          0.039 0.106 0.292 0.15 0.563 0.090 0.558 0.239 0.774 0.446 0.643
          0.411-0.258 0.618-1.345
          0.36-1.889-0.096-0.202-0.197-0.296-0.351-0.326-0.249-0.050-0.409-0.209-0.334-0.331
          0.068-0.11 0.488-0.021 0.677 0.143 0.761 0.659 0.397 2.756-0.478
          2.756-0.299
          0-0.456-0.228-0.518-0.753-0.025-0.215-0.070-0.391-0.099-0.391s-0.178
          0.182-0.331 0.404c-0.401 0.582-0.685 0.84-0.8 0.725zM12.201
          17.782c-0.276-0.117-0.43-0.424-0.384-0.767 0.081-0.603 0.653-1.294
          1.072-1.295 0.223-0.001 0.585 0.413 0.585 0.668 0 0.372-0.237
          0.514-0.847 0.508-0.48-0.005-0.526 0.008-0.534 0.153-0.014 0.253 0.018
          0.383 0.112 0.448 0.097 0.067 0.698 0.028 0.908-0.059 0.201-0.083
          0.163 0.090-0.049 0.229-0.232 0.152-0.645 0.207-0.862 0.115zM13.051
          16.623c0.107-0.049 0.194-0.14 0.194-0.204
          0-0.158-0.226-0.395-0.374-0.392-0.219 0.004-0.666 0.467-0.582 0.603
          0.067 0.108 0.519 0.103 0.762-0.007zM14.036
          17.766c-0.277-0.134-0.365-0.384-0.253-0.723 0.197-0.601 0.818-1.324
          1.137-1.324 0.185 0 0.56 0.443 0.502 0.594-0.024 0.063-0.062
          0.307-0.085 0.542s-0.067 0.564-0.101 0.732c-0.058 0.292-0.077
          0.286-0.193-0.069-0.046-0.141-0.052-0.141-0.217 0.010-0.186
          0.169-0.467 0.329-0.565
          0.321-0.034-0.003-0.136-0.041-0.225-0.084zM14.648 17.318c0.447-0.392
          0.658-1.216 0.328-1.279-0.381-0.073-1.215 1.323-0.873 1.461 0.192
          0.077 0.286 0.046 0.545-0.182zM16.16 17.736c-0.212-0.149-0.211-0.237
          0.016-0.968l0.184-0.591h-0.223c-0.323 0-0.29-0.209 0.043-0.272
          0.251-0.047 0.268-0.070 0.315-0.423 0.027-0.205 0.075-0.373
          0.107-0.373 0.14 0 0.239 0.236 0.191 0.454-0.050 0.229-0.047 0.232
          0.26 0.232 0.413 0 0.394 0.1-0.045 0.234l-0.356 0.109-0.186
          0.637c-0.224 0.766-0.185 0.846 0.325 0.672 0.419-0.143 0.437-0.033
          0.041 0.236-0.299 0.202-0.442 0.214-0.671 0.053zM17.598
          17.748c-0.069-0.083-0.055-0.244 0.062-0.705 0.214-0.848 0.39-1.823
          0.39-2.165 0-0.346 0.11-0.448 0.234-0.216 0.115 0.216 0.045
          0.831-0.199 1.745-0.104 0.39-0.178 0.72-0.165 0.734s0.2-0.246
          0.414-0.577c0.214-0.331 0.482-0.663 0.596-0.738 0.205-0.134
          0.209-0.133 0.388 0.074 0.221 0.257 0.227 0.495 0.027 1.139-0.169
          0.546-0.45 0.982-0.453 0.702-0.001-0.084 0.067-0.37 0.15-0.636
          0.182-0.58 0.192-0.84 0.034-0.901-0.17-0.065-0.358 0.136-0.878
          0.938-0.254 0.392-0.473 0.713-0.487
          0.713s-0.065-0.048-0.114-0.107zM20.124
          17.666c-0.203-0.171-0.244-0.258-0.242-0.523 0.003-0.564 0.442-1.245
          0.891-1.38 0.382-0.115 0.871 0.407 0.747 0.797-0.073 0.231-0.517
          0.397-0.984 0.367-0.376-0.024-0.389-0.018-0.413 0.189-0.039 0.344
          0.111 0.456 0.555 0.414 0.211-0.020 0.444-0.062 0.518-0.093
          0.203-0.086 0.162 0.090-0.054 0.232-0.103 0.068-0.319 0.141-0.48
          0.162-0.24 0.032-0.336 0.002-0.537-0.166zM21.232 16.536c0.11-0.11
          0.109-0.138-0.007-0.316-0.070-0.107-0.199-0.195-0.286-0.195-0.197
          0-0.708 0.497-0.635 0.617 0.076 0.123 0.779 0.043 0.928-0.106zM21.909
          17.734c-0.026-0.067 0.008-0.31 0.075-0.54s0.129-0.639
          0.138-0.909c0.018-0.539 0.118-0.659 0.238-0.287l0.078 0.241
          0.283-0.26c0.285-0.261 0.467-0.322 0.551-0.186 0.025 0.040-0.092
          0.161-0.261 0.267-0.335 0.212-0.505 0.497-0.763 1.28-0.171 0.519-0.254
          0.616-0.339 0.394zM26.797
          17.805c-0.023-0.037-0.066-0.315-0.096-0.618-0.034-0.345-0.088-0.551-0.145-0.551-0.050
          0-0.26 0.050-0.467 0.112-0.361 0.107-0.383 0.131-0.554 0.572-0.098
          0.253-0.21 0.46-0.25 0.46-0.138 0-0.153-0.212-0.034-0.496 0.146-0.348
          0.145-0.343 0.005-0.343-0.193 0-0.127-0.205 0.095-0.298 0.169-0.071
          0.267-0.231 0.508-0.829 0.312-0.777 0.457-1.008 0.631-1.008 0.135 0
          0.232 0.263 0.341 0.921 0.079 0.479 0.104 0.528 0.267 0.528 0.225 0
          0.234 0.137 0.015 0.218-0.15 0.056-0.163 0.11-0.151 0.627 0.012
          0.524-0.066 0.864-0.164 0.706zM26.39
          16.361l0.219-0.052-0.052-0.504c-0.028-0.277-0.080-0.533-0.116-0.568s-0.171
          0.212-0.301 0.55c-0.277 0.719-0.277 0.718-0.104 0.666 0.073-0.022
          0.232-0.063 0.353-0.092zM0.688 17.659c-0.025-0.066 0.063-0.589
          0.197-1.163s0.255-1.101
          0.269-1.173c0.022-0.109-0.047-0.134-0.441-0.153-0.382-0.018-0.473-0.048-0.494-0.162-0.025-0.131
          0.039-0.138 1.007-0.114 0.861 0.021 1.056 0.047 1.167 0.159 0.127
          0.127 0.107 0.133-0.417 0.133-0.506 0-0.55 0.013-0.55 0.158 0
          0.289-0.545 2.434-0.619 2.434-0.040 0-0.093-0.054-0.118-0.12z" />
      </svg>

    </div>
  </div>
  <div class="search-wrap">
    <div class="search-box">
      <label class="search-label">
        Search for a city
        <input class="search-input" type="text" bind:value />
      </label>

      <div class="search-results">
        {#each cities as city}
          <a
            on:click={event => {
              addCity(city, event);
            }}
            class="search-results--item"
            href="forecast?city={city.name}&id={city.id}">
            <span>{city.name} ({city.sys.country})</span>
            {#if city.main}
              <span class="temperature">
                {(city.main.temp - 272.15).toFixed(1)}°C
              </span>
            {:else}
              <svg
                class="delete"
                viewBox="0 0 22 28"
                on:click={event => {
                  deleteCity(city, event);
                }}>
                <title>delete</title>
                <path
                  d="M8 11.5v9c0 0.281-0.219 0.5-0.5 0.5h-1c-0.281
                  0-0.5-0.219-0.5-0.5v-9c0-0.281 0.219-0.5 0.5-0.5h1c0.281 0 0.5
                  0.219 0.5 0.5zM12 11.5v9c0 0.281-0.219 0.5-0.5 0.5h-1c-0.281
                  0-0.5-0.219-0.5-0.5v-9c0-0.281 0.219-0.5 0.5-0.5h1c0.281 0 0.5
                  0.219 0.5 0.5zM16 11.5v9c0 0.281-0.219 0.5-0.5 0.5h-1c-0.281
                  0-0.5-0.219-0.5-0.5v-9c0-0.281 0.219-0.5 0.5-0.5h1c0.281 0 0.5
                  0.219 0.5 0.5zM18 22.813v-14.812h-14v14.812c0 0.75 0.422 1.188
                  0.5 1.188h13c0.078 0 0.5-0.438 0.5-1.188zM7.5
                  6h7l-0.75-1.828c-0.047-0.063-0.187-0.156-0.266-0.172h-4.953c-0.094
                  0.016-0.219 0.109-0.266 0.172zM22 6.5v1c0 0.281-0.219 0.5-0.5
                  0.5h-1.5v14.812c0 1.719-1.125 3.187-2.5 3.187h-13c-1.375
                  0-2.5-1.406-2.5-3.125v-14.875h-1.5c-0.281
                  0-0.5-0.219-0.5-0.5v-1c0-0.281 0.219-0.5
                  0.5-0.5h4.828l1.094-2.609c0.313-0.766 1.25-1.391
                  2.078-1.391h5c0.828 0 1.766 0.625 2.078 1.391l1.094
                  2.609h4.828c0.281 0 0.5 0.219 0.5 0.5z" />
              </svg>
            {/if}
          </a>
        {/each}
      </div>
    </div>
  </div>

</section>

<canvas class="canvas" bind:this={canvas} width="800" height="800" />
